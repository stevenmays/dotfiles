# Claude Sync Makefile - Copy to target repos
# Usage: make -f Makefile.claude sync
#
# Commands are prefixed with custom- to distinguish from plugin commands

DOTFILES := $(HOME)/Git/dotfiles/ai/claude
USER_DIR := $(HOME)/.claude
RSYNC := rsync -av --delete

.PHONY: all sync sync-force dry-run clean help

all: sync

sync:
	@cd $(DOTFILES)/../.. && git pull --ff-only
	@if [ -f ./CLAUDE.md ]; then \
		echo "CLAUDE.md exists. Replace? [y/N] " && read ans && \
		if [ "$$ans" = "y" ] || [ "$$ans" = "Y" ]; then \
			cp $(DOTFILES)/CLAUDE.md ./CLAUDE.md; \
			echo "✓ CLAUDE.md replaced"; \
		else \
			echo "→ CLAUDE.md skipped"; \
		fi; \
	else \
		cp $(DOTFILES)/CLAUDE.md ./CLAUDE.md; \
		echo "✓ CLAUDE.md created"; \
	fi
	@mkdir -p .claude/.agent $(USER_DIR)/commands $(USER_DIR)/skills $(USER_DIR)/hooks
	@$(RSYNC) $(DOTFILES)/.agent/ .claude/.agent/
	@for f in $(DOTFILES)/commands/*.md; do \
		name=$$(basename "$$f"); \
		cp "$$f" "$(USER_DIR)/commands/custom-$$name"; \
	done
	@$(RSYNC) $(DOTFILES)/skills/ $(USER_DIR)/skills/
	@$(RSYNC) $(DOTFILES)/hooks/ $(USER_DIR)/hooks/
	@echo "✓ Synced"

sync-force:
	@cd $(DOTFILES)/../.. && git pull --ff-only
	@cp $(DOTFILES)/CLAUDE.md ./CLAUDE.md
	@mkdir -p .claude/.agent $(USER_DIR)/commands $(USER_DIR)/skills $(USER_DIR)/hooks
	@$(RSYNC) $(DOTFILES)/.agent/ .claude/.agent/
	@for f in $(DOTFILES)/commands/*.md; do \
		name=$$(basename "$$f"); \
		cp "$$f" "$(USER_DIR)/commands/custom-$$name"; \
	done
	@$(RSYNC) $(DOTFILES)/skills/ $(USER_DIR)/skills/
	@$(RSYNC) $(DOTFILES)/hooks/ $(USER_DIR)/hooks/
	@echo "✓ Synced (forced)"

dry-run:
	@echo "=== CLAUDE.md ===" && diff -q $(DOTFILES)/CLAUDE.md ./CLAUDE.md 2>/dev/null || echo "Would update"
	@echo "=== .agent ===" && $(RSYNC) --dry-run $(DOTFILES)/.agent/ .claude/.agent/ 2>/dev/null || true
	@echo "=== commands (will be prefixed with custom-) ==="
	@for f in $(DOTFILES)/commands/*.md; do echo "  custom-$$(basename $$f)"; done
	@echo "=== skills ===" && $(RSYNC) --dry-run $(DOTFILES)/skills/ $(USER_DIR)/skills/ 2>/dev/null || true
	@echo "=== hooks ===" && $(RSYNC) --dry-run $(DOTFILES)/hooks/ $(USER_DIR)/hooks/ 2>/dev/null || true

clean:
	rm -f ./CLAUDE.md
	rm -rf .claude/.agent

help:
	@echo "make sync       - Sync config (prompts before replacing CLAUDE.md)"
	@echo "make sync-force - Sync config (overwrites CLAUDE.md without prompt)"
	@echo "make dry-run    - Preview changes"
	@echo "make clean      - Remove repo Claude files"
